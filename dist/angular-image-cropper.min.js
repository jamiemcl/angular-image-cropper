!function(t){"use strict";t.module("imageCropper",[])}(angular),function(t){"use strict";t.module("imageCropper").constant("defaultConfig",{width:400,height:300,zoomStep:.1,init:null,showControls:!0,fitOnInit:!1})}(angular),function(t){"use strict";function e(){function t(t){return o.test(t.type)}function e(e){return t(e)?1===e.originalEvent.changedTouches.length:1===e.which}function n(e){return t(e)&&(e=e.originalEvent.touches[0]),{x:e.pageX,y:e.pageY}}function i(){if(null!==r)return r;var t,e,n,i,o,a,u,l,s;for(n=["webkit","Moz","O","ms","Khtml"],a={transform:"transform"},l=0,s=n.length;s>l;l++)e=n[l],a[e+"Transform"]="-"+e.toLowerCase()+"-transform";t=document.createElement("img"),document.body.insertBefore(t,null);for(o in a)if(i=a[o],void 0!==t.style[o]&&(t.style[o]="rotate(90deg)",u=window.getComputedStyle(t).getPropertyValue(i),null!==u&&u.length&&"none"!==u)){r=!0;break}return document.body.removeChild(t),r}var o=/touch/i,r=null,a={canTransform:i,getPointerPosition:n,isTouch:t,validEvent:e};return a}t.module("imageCropper").factory("Helper",e),e.$inject=["defaultConfig"]}(angular),function(t){"use strict";function e(t,e){function n(t,n,o,s){return r=document.createElement("canvas"),r.width=o,r.height=s,a=r.getContext("2d"),l=n,c=e.defer(),u=new Image,u.src=t.src,u.onload=i,c.promise}function i(){return a.save(),a.scale(l.scale,l.scale),a.rotate(l.angle*Math.PI/180),90===l.angle?(a.translate(0,-u.height),a.translate(-l.y/l.scale,l.x/l.scale)):180===l.angle?(a.translate(-u.width,-u.height),a.translate(l.x/l.scale,l.y/l.scale)):270===l.angle?(a.translate(-u.width,0),a.translate(l.y/l.scale,-l.x/l.scale)):a.translate(-l.x/l.scale,-l.y/l.scale),a.drawImage(u,0,0),a.restore(),s=r.toDataURL("image/jpeg"),c.resolve(s)}function o(){return s}var r,a,u,l,s,c,g={crop:n,get:o};return g}t.module("imageCropper").factory("Cropper",e),e.$inject=["Helper","$q"]}(angular),function(t){"use strict";function e(e,n,i){function o(o,r){var a=!1,u=t.element("body"),l=r.find("img"),s=r.find(".imgCropper-canvas"),c=r.find(".imgCropper-window"),g={};g.width=+o.destWidth||n.width,g.height=+o.destHeight||n.height,g.zoomStep=+o.zoomStep||n.zoomStep,g.init=o.init||n.init,g.fitOnInit=o.fitOnInit||n.fitOnInit;var d,h,f,m,p,v=1+g.zoomStep,y=1/v,w=g.height/g.width;d=h=f=m=p=0;var b,C={scale:1,angle:0,x:0,y:0,w:g.width,h:g.height},x={start:"touchstart mousedown",move:"touchmove mousemove",stop:"touchend mouseup"},I=function(){d=l[0].naturalWidth/g.width,h=l[0].naturalHeight/g.height,s.css({width:100*d+"%",height:100*h+"%",top:0,left:0}),c.css({width:"100%",height:"auto","padding-top":g.height/g.width*100+"%"}),a=!0},k=function(t){return a&&i.validEvent(t)?(t.preventDefault(),t.stopImmediatePropagation(),b=i.getPointerPosition(t),z()):void 0},z=function(){return u.addClass("imgCropper-dragging"),s.on(x.move,H),s.on(x.stop,O)},O=function(){u.removeClass("imgCropper-dragging"),s.off(x.move,H),s.off(x.stop,O)},P=function(t,e){return(t||0===t)&&(0>t&&(t=0),t>d-1&&(t=d-1),s[0].style.left=(100*-t).toFixed(2)+"%",f=t,C.x=Math.round(t*g.width)),(e||0===e)&&(0>e&&(e=0),e>h-1&&(e=h-1),s[0].style.top=(100*-e).toFixed(2)+"%",m=e,C.y=Math.round(e*g.height)),T()},H=function(t){var e,n,o,r,a;return t.preventDefault(),t.stopImmediatePropagation(),r=i.getPointerPosition(t),e=r.x-b.x,n=r.y-b.y,b=r,o=0===e?null:f-e/c[0].clientWidth,a=0===n?null:m-n/c[0].clientHeight,P(o,a)},E=function(t){var e,n,i,o;return t>0&&1!==t?(o=d,e=h,o*t>1&&e*t>1?(d*=t,h*=t,s[0].style.width=(100*d).toFixed(2)+"%",s[0].style.height=(100*h).toFixed(2)+"%",C.scale*=t):(F(),t=d/o),n=(f+.5)*t-.5,i=(m+.5)*t-.5,P(n,i)):void 0},F=function(){var t,e;return t=d,e=h/d,e>1?(d=1,h=e):(d=1/e,h=1),s[0].style.width=(100*d).toFixed(2)+"%",s[0].style.height=(100*h).toFixed(2)+"%",C.scale*=d/t,T()},S=function(){return P((d-1)/2,(h-1)/2)},R=function(t){var e,n,o,r,a,u;return i.canTransform()&&0!==t&&t%90===0?(p=(p+t)%360,0>p&&(p=360+p),t%180!==0&&(r=[h*w,d/w],d=r[0],h=r[1],1>d||1>h?F():(s[0].style.width=100*d+"%",s[0].style.height=100*h+"%")),a=[1,1],o=a[0],n=a[1],p%180!==0&&(e=h/d*w,u=[e,1/e],o=u[0],n=u[1]),l[0].style.width=100*o+"%",l[0].style.height=100*n+"%",l[0].style.left=(1-o)/2*100+"%",l[0].style.top=(1-n)/2*100+"%",l.css({transform:"rotate("+p+"deg)"}),S(),C.angle=p,T()):void 0};o.rotateLeft=function(){R(-90)},o.rotateRight=function(){R(90)},o.center=function(){S()},o.fit=function(){F(),S()},o.zoomIn=function(){E(v)},o.zoomOut=function(){E(y),T()};var T=function(){e.crop(l[0],C,g.width,g.height).then(function(t){o.croppedImage=t})};l[0].onload=function(){var t=this;I(),W(l),(t.naturalWidth<g.width||t.naturalHeight<g.height||g.fitOnInit)&&F(),S(),r.find("img").on(x.start,k),T()};var W=function(e){return t.element(e).css({"-webkit-perspective":1e3,perspective:1e3,"-webkit-backface-visibility":"hidden","backface-visibility":"hidden"})}}return{restrict:"E",scope:{image:"@",destWidth:"@",destHeight:"@",zoomStep:"@",init:"@",croppedImage:"=",showControls:"=",fitOnInit:"="},template:'<div class="frame"><div class="imgCropper-window"><div class="imgCropper-canvas"><img crossOrigin="anonymous" ng-src="{{image}}"></div></div></div><div id="controls" ng-if="showControls"><button ng-click="rotateLeft()" type="button" title="Rotate left"> &lt; </button><button ng-click="zoomOut()" type="button" title="Zoom out"> - </button><button ng-click="fit()" type="button" title="Fit image"> [ ] </button><button ng-click="zoomIn()" type="button" title="Zoom in"> + </button><button ng-click="rotateRight()" type="button" title="Rotate right"> &gt; </button></div>',link:o}}t.module("imageCropper").directive("imageCropper",e),e.$inject=["Cropper","defaultConfig","Helper"]}(angular);
